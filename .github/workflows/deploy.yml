name: Deploy to AWS EC2

on:
    push:
        branches:
            - main

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v2
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ap-southeast-2

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1

            - name: Build & Push Backend
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  ECR_REPOSITORY: self/ctm-backend
                  IMAGE_TAG: latest
              run: |
                  docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./backend
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            - name: Build & Push Frontend
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  ECR_REPOSITORY: self/ctm-frontend
                  IMAGE_TAG: latest
              run: |
                  docker build \
                    --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
                    --build-arg NEXT_PUBLIC_BASE_URL_SITES=${{ secrets.NEXT_PUBLIC_API_URL }} \
                    --build-arg NEXT_PUBLIC_BASE_URL_CUSTOMERS=${{ secrets.NEXT_PUBLIC_API_URL }}/customers \
                    -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./frontend
                  docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    deploy:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v0.1.10
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -e

                      echo "=== Checking Docker ==="
                      docker --version || { echo "Docker not installed!"; exit 1; }

                      echo "=== Checking Docker Compose ==="
                      docker compose version || docker-compose --version || { echo "Docker Compose not installed!"; exit 1; }

                      echo "=== Login to ECR ==="
                      aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

                      echo "=== Pulling images ==="
                      docker pull ${{ secrets.ECR_REGISTRY }}/self/ctm-backend:latest
                      docker pull ${{ secrets.ECR_REGISTRY }}/self/ctm-frontend:latest

                      echo "=== Creating docker-compose.yml ==="
                      cat <<EOF > docker-compose.yml
                      version: '3.8'
                      services:
                        backend:
                          image: ${{ secrets.ECR_REGISTRY }}/self/ctm-backend:latest
                          restart: always
                          ports:
                            - "13000:3000"
                          environment:
                            MYSQL_HOST: ${{ secrets.RDS_ENDPOINT }}
                            MYSQL_USER: admin
                            MYSQL_PASSWORD: ${{ secrets.RDS_PASSWORD }}
                            MYSQL_DATABASE: ctm
                            PORT: 3000
                            APP_URL: ${{ secrets.APP_URL }}

                        frontend:
                          image: ${{ secrets.ECR_REGISTRY }}/self/ctm-frontend:latest
                          restart: always
                          ports:
                            - "15173:5173"
                      EOF

                      echo "=== Stopping old containers ==="
                      docker compose down || docker-compose down || true

                      echo "=== Starting new containers ==="
                      docker compose up -d || docker-compose up -d

                      echo "=== Listing running containers ==="
                      docker ps

                      echo "=== Cleanup ==="
                      docker system prune -f
