{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["// ============================================================================\r\n// MIDDLEWARE - Kết hợp next-intl với Authentication logic\r\n// ============================================================================\r\n// File này xử lý:\r\n// 1. i18n routing (locale detection, URL rewriting)\r\n// 2. Authentication checks (protected routes, auth redirects)\r\n//\r\n// Middleware chạy TRƯỚC KHI request đến page/API route\r\n// Cho phép intercept và modify request/response\r\n// ============================================================================\r\n\r\n// import createMiddleware from \"next-intl/middleware\";\r\n// import { routing } from \"@/i18n/routing\";\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\n\r\n// ============================================================================\r\n// STEP 1: Tạo i18n Middleware\r\n// ============================================================================\r\n// createMiddleware() từ next-intl nhận routing config và tạo ra một middleware\r\n// Middleware này sẽ:\r\n// - Detect locale từ URL, cookie, hoặc Accept-Language header\r\n// - Redirect nếu thiếu locale trong URL (/ → /vi)\r\n// - Rewrite URL để Next.js routing hoạt động đúng\r\n// - Set locale cookie để lưu preference của user\r\n//\r\n// VD hoạt động:\r\n// Request: /\r\n// → Middleware detect locale = 'vi' (từ cookie hoặc browser)\r\n// → Redirect to: /vi\r\n//\r\n// Request: /san-pham\r\n// → Middleware phát hiện thiếu locale\r\n// → Redirect to: /vi/san-pham\r\n// ============================================================================\r\n// const intlMiddleware = createMiddleware(routing);\r\n\r\n// ============================================================================\r\n// STEP 2: Custom Middleware - Kết hợp i18n + Auth logic\r\n// ============================================================================\r\nexport async function middleware(request: NextRequest) {\r\n    // ------------------------------------------------------------------------\r\n    // 2.1: Chạy i18n middleware TRƯỚC\r\n    // ------------------------------------------------------------------------\r\n    // Gọi intlMiddleware để xử lý locale detection và URL rewriting\r\n    // Response này có thể là:\r\n    // - NextResponse (normal): Cho phép request tiếp tục\r\n    // - RedirectResponse: Redirect đến URL có locale\r\n    //\r\n    // Tại sao chạy trước?\r\n    // - Đảm bảo pathname đã có locale prefix\r\n    // - Giúp auth logic dễ dàng check paths với locale\r\n    // ------------------------------------------------------------------------\r\n    // const response = intlMiddleware(request);\r\n    // ------------------------------------------------------------------------\r\n    // 2.2: Extract locale từ pathname\r\n    // ------------------------------------------------------------------------\r\n    // Pathname format: /[locale]/[...rest]\r\n    // VD: /vi/san-pham → split('/') → ['', 'vi', 'san-pham']\r\n    //                  → [1] = 'vi'\r\n    //\r\n    // Locale này dùng để:\r\n    // - Build auth paths cho từng ngôn ngữ\r\n    // - Redirect đúng locale khi cần\r\n    // ------------------------------------------------------------------------\r\n    // const locale = request.nextUrl.pathname.split(\"/\")[1];\r\n    // ------------------------------------------------------------------------\r\n    // 2.3: Lấy authentication token và pathname\r\n    // ------------------------------------------------------------------------\r\n    // refreshToken: Cookie chứa refresh token\r\n    // pathname: Full path của request (/vi/khach-hang/dang-nhap)\r\n    // ------------------------------------------------------------------------\r\n    // const token = request.cookies.get(\"refreshToken\")?.value;\r\n    // const { pathname } = request.nextUrl;\r\n    // ------------------------------------------------------------------------\r\n    // 2.4: Define auth paths cho MỖI locale\r\n    // ------------------------------------------------------------------------\r\n    // Auth paths là các routes mà user ĐÃ ĐĂNG NHẬP không nên truy cập\r\n    // VD: Đã login rồi thì không cần vào trang login nữa\r\n    //\r\n    // Bao gồm CẢ 2 versions (vi và en) của mỗi route:\r\n    // - /vi/customers/login (internal pathname, ít khi xảy ra)\r\n    // - /vi/khach-hang/dang-nhap (external pathname, URL thật)\r\n    // - /en/customers/login (external pathname cho English)\r\n    //\r\n    // Tại sao cần cả 2?\r\n    // - User có thể type trực tiếp URL\r\n    // - Direct navigation từ bookmarks\r\n    // - SEO crawlers có thể access cả 2 versions\r\n    // ------------------------------------------------------------------------\r\n    // const authPaths = [\r\n    //     `/${locale}/customers/login`, // Internal pathname\r\n    //     `/${locale}/khach-hang/dang-nhap`, // External pathname (vi)\r\n    //     `/${locale}/customers/register`, // Internal pathname\r\n    //     `/${locale}/khach-hang/dang-ky`, // External pathname (vi)\r\n    // ];\r\n    // ------------------------------------------------------------------------\r\n    // 2.5: Redirect authenticated users từ auth pages\r\n    // ------------------------------------------------------------------------\r\n    // Logic: Nếu user ĐÃ có token VÀ đang cố truy cập auth pages\r\n    // → Redirect về dashboard (đã login rồi không cần login nữa)\r\n    //\r\n    // Flow:\r\n    // 1. Check: pathname có trong authPaths? && token exists?\r\n    // 2. Yes → Redirect to /${locale}/dashboard\r\n    // 3. No → Cho phép tiếp tục\r\n    //\r\n    // VD:\r\n    // - User đã login, vào /vi/khach-hang/dang-nhap\r\n    // - Middleware detect token → Redirect to /vi/dashboard\r\n    // ------------------------------------------------------------------------\r\n    // if (authPaths.includes(pathname) && token) {\r\n    //     try {\r\n    //         // TODO: Optionally verify token here\r\n    //         // const isValid = await verifyToken(token);\r\n    //         // if (!isValid) throw new Error('Invalid token');\r\n    //         // Redirect về dashboard nếu đã đăng nhập\r\n    //         return NextResponse.redirect(new URL(`/${locale}/`, request.url));\r\n    //     } catch {\r\n    //         // Token invalid hoặc expired\r\n    //         // → Cho phép user vào login page để login lại\r\n    //         // (Không làm gì, fall through to return response)\r\n    //     }\r\n    // }\r\n    // ------------------------------------------------------------------------\r\n    // 2.6: Protected routes (COMMENTED - Example)\r\n    // ------------------------------------------------------------------------\r\n    // Code này được comment nhưng là example cho protected routes\r\n    // Protected routes: Routes chỉ user ĐĂNG NHẬP mới được truy cập\r\n    //\r\n    // Logic:\r\n    // 1. Define protected paths (profile, admin, etc.)\r\n    // 2. Check: pathname starts with protected path? && NO token?\r\n    // 3. Yes → Redirect to login page với redirect parameter\r\n    // 4. User login xong sẽ được redirect về page ban đầu\r\n    //\r\n    // VD Flow:\r\n    // - User chưa login, vào /vi/profile\r\n    // - Middleware detect không có token\r\n    // - Redirect to /vi/khach-hang/dang-nhap?redirect=/vi/profile\r\n    // - User login xong → Redirect về /vi/profile\r\n    // ------------------------------------------------------------------------\r\n    // const protectedPaths = [`/${locale}/profile`, `/${locale}/admin`];\r\n    // if (protectedPaths.some((path) => pathname.startsWith(path))) {\r\n    //     if (!token) {\r\n    //         // Build login URL dựa trên locale\r\n    //         const loginUrl = locale === 'vi'\r\n    //             ? `/${locale}/khach-hang/dang-nhap`\r\n    //             : `/${locale}/customers/login`;\r\n    //\r\n    //         // Add redirect parameter để redirect về page ban đầu sau login\r\n    //         const url = new URL(\r\n    //             `${loginUrl}?redirect=${encodeURIComponent(pathname)}`,\r\n    //             request.url\r\n    //         );\r\n    //         return NextResponse.redirect(url);\r\n    //     }\r\n    // }\r\n    // ------------------------------------------------------------------------\r\n    // 2.7: Return response từ i18n middleware\r\n    // ------------------------------------------------------------------------\r\n    // Nếu không có auth redirects → Return response từ intlMiddleware\r\n    // Response này có thể là:\r\n    // - Normal response: Request tiếp tục đến page\r\n    // - Redirect response: Redirect đến URL với locale\r\n    // ------------------------------------------------------------------------\r\n    // return response;\r\n}\r\n\r\n// ============================================================================\r\n// MIDDLEWARE CONFIG - Định nghĩa routes nào sẽ chạy middleware\r\n// ============================================================================\r\nexport const config = {\r\n    // matcher: Array of patterns để match với request paths\r\n    // Middleware CHỈ chạy cho paths match với patterns này\r\n    // matcher: [\r\n    // ------------------------------------------------------------------------\r\n    // Pattern 1: Skip Next.js internals và static files\r\n    // ------------------------------------------------------------------------\r\n    // Negative lookahead regex: /((?!pattern).*)\r\n    // Match tất cả NGOẠI TRỪ:\r\n    // - _next: Next.js internal routes (/_next/static/...)\r\n    // - api: API routes (/api/...)\r\n    // - favicon.ico: Browser favicon request\r\n    // - assets: Static assets folder (/assets/...)\r\n    // - public: Public folder (/public/...)\r\n    // - .*\\\\..*: Files with extensions (/image.jpg, /style.css)\r\n    //\r\n    // Tại sao skip?\r\n    // - Không cần i18n cho static files\r\n    // - Performance: Giảm số lần middleware chạy\r\n    // - API routes có thể có own middleware\r\n    // ------------------------------------------------------------------------\r\n    // \"/((?!_next|api|favicon.ico|assets|public|.*\\\\..*).*)\",\r\n    // ------------------------------------------------------------------------\r\n    // Pattern 2: Root path\r\n    // ------------------------------------------------------------------------\r\n    // Match exactly \"/\"\r\n    // Cần thiết để redirect / → /vi (default locale)\r\n    // ------------------------------------------------------------------------\r\n    // \"/\",\r\n    // ------------------------------------------------------------------------\r\n    // Pattern 3: All locale paths\r\n    // ------------------------------------------------------------------------\r\n    // Match: /{locale}/{anything}\r\n    // VD: /vi/san-pham, /en/products, /vi/khach-hang/dang-nhap\r\n    //\r\n    // :path* là Next.js matcher syntax:\r\n    // - :path là dynamic segment\r\n    // - * là zero or more segments\r\n    //\r\n    // VD matches:\r\n    // ✅ /vi\r\n    // ✅ /vi/san-pham\r\n    // ✅ /vi/san-pham/123\r\n    // ✅ /en/products/category/electronics\r\n    // ❌ /xyz (locale không hợp lệ, nhưng sẽ match pattern 1)\r\n    // ------------------------------------------------------------------------\r\n    // \"/(vi|en)/:path*\",\r\n    // ],\r\n};\r\n\r\n// ============================================================================\r\n// FLOW TỔNG QUAN\r\n// ============================================================================\r\n//\r\n// Request: GET /san-pham\r\n// ↓\r\n// 1. Middleware chạy (match với pattern 1)\r\n// ↓\r\n// 2. intlMiddleware detect thiếu locale\r\n// ↓\r\n// 3. Check cookie NEXT_LOCALE → có 'vi'\r\n// ↓\r\n// 4. Redirect to /vi/san-pham\r\n// ↓\r\n// 5. Browser request lại: GET /vi/san-pham\r\n// ↓\r\n// 6. Middleware chạy lại (match với pattern 3)\r\n// ↓\r\n// 7. intlMiddleware OK, extract locale = 'vi'\r\n// ↓\r\n// 8. Auth logic: Check authPaths → không match\r\n// ↓\r\n// 9. Return response → Request tiếp tục\r\n// ↓\r\n// 10. Next.js routing: Match với app/[locale]/(pages)/...\r\n// ↓\r\n// 11. Load messages từ src/messages/vi.json\r\n// ↓\r\n// 12. Render page với translations\r\n//\r\n// ============================================================================\r\n"],"names":[],"mappings":"AAAA,+EAA+E;AAC/E,0DAA0D;AAC1D,+EAA+E;AAC/E,kBAAkB;AAClB,oDAAoD;AACpD,8DAA8D;AAC9D,EAAE;AACF,uDAAuD;AACvD,gDAAgD;AAChD,+EAA+E;AAE/E,uDAAuD;AACvD,4CAA4C;;;;;;;AA2BrC,eAAe,WAAW,OAAoB;AACjD,2EAA2E;AAC3E,kCAAkC;AAClC,2EAA2E;AAC3E,gEAAgE;AAChE,0BAA0B;AAC1B,qDAAqD;AACrD,iDAAiD;AACjD,EAAE;AACF,sBAAsB;AACtB,yCAAyC;AACzC,mDAAmD;AACnD,2EAA2E;AAC3E,4CAA4C;AAC5C,2EAA2E;AAC3E,kCAAkC;AAClC,2EAA2E;AAC3E,uCAAuC;AACvC,yDAAyD;AACzD,gCAAgC;AAChC,EAAE;AACF,sBAAsB;AACtB,uCAAuC;AACvC,iCAAiC;AACjC,2EAA2E;AAC3E,yDAAyD;AACzD,2EAA2E;AAC3E,4CAA4C;AAC5C,2EAA2E;AAC3E,0CAA0C;AAC1C,6DAA6D;AAC7D,2EAA2E;AAC3E,4DAA4D;AAC5D,wCAAwC;AACxC,2EAA2E;AAC3E,wCAAwC;AACxC,2EAA2E;AAC3E,mEAAmE;AACnE,qDAAqD;AACrD,EAAE;AACF,kDAAkD;AAClD,2DAA2D;AAC3D,2DAA2D;AAC3D,wDAAwD;AACxD,EAAE;AACF,oBAAoB;AACpB,mCAAmC;AACnC,mCAAmC;AACnC,6CAA6C;AAC7C,2EAA2E;AAC3E,sBAAsB;AACtB,yDAAyD;AACzD,mEAAmE;AACnE,4DAA4D;AAC5D,iEAAiE;AACjE,KAAK;AACL,2EAA2E;AAC3E,kDAAkD;AAClD,2EAA2E;AAC3E,6DAA6D;AAC7D,6DAA6D;AAC7D,EAAE;AACF,QAAQ;AACR,0DAA0D;AAC1D,4CAA4C;AAC5C,4BAA4B;AAC5B,EAAE;AACF,MAAM;AACN,gDAAgD;AAChD,wDAAwD;AACxD,2EAA2E;AAC3E,+CAA+C;AAC/C,YAAY;AACZ,gDAAgD;AAChD,uDAAuD;AACvD,6DAA6D;AAC7D,oDAAoD;AACpD,6EAA6E;AAC7E,gBAAgB;AAChB,wCAAwC;AACxC,yDAAyD;AACzD,6DAA6D;AAC7D,QAAQ;AACR,IAAI;AACJ,2EAA2E;AAC3E,8CAA8C;AAC9C,2EAA2E;AAC3E,8DAA8D;AAC9D,gEAAgE;AAChE,EAAE;AACF,SAAS;AACT,mDAAmD;AACnD,8DAA8D;AAC9D,yDAAyD;AACzD,sDAAsD;AACtD,EAAE;AACF,WAAW;AACX,qCAAqC;AACrC,qCAAqC;AACrC,8DAA8D;AAC9D,8CAA8C;AAC9C,2EAA2E;AAC3E,qEAAqE;AACrE,kEAAkE;AAClE,oBAAoB;AACpB,6CAA6C;AAC7C,2CAA2C;AAC3C,kDAAkD;AAClD,8CAA8C;AAC9C,EAAE;AACF,0EAA0E;AAC1E,+BAA+B;AAC/B,sEAAsE;AACtE,0BAA0B;AAC1B,aAAa;AACb,6CAA6C;AAC7C,QAAQ;AACR,IAAI;AACJ,2EAA2E;AAC3E,0CAA0C;AAC1C,2EAA2E;AAC3E,kEAAkE;AAClE,0BAA0B;AAC1B,+CAA+C;AAC/C,mDAAmD;AACnD,2EAA2E;AAC3E,mBAAmB;AACvB;AAKO,MAAM,SAAS;AAgDtB,GAEA,+EAA+E;CAC/E,iBAAiB;CACjB,+EAA+E;CAC/E,EAAE;CACF,yBAAyB;CACzB,IAAI;CACJ,2CAA2C;CAC3C,IAAI;CACJ,wCAAwC;CACxC,IAAI;CACJ,wCAAwC;CACxC,IAAI;CACJ,8BAA8B;CAC9B,IAAI;CACJ,2CAA2C;CAC3C,IAAI;CACJ,+CAA+C;CAC/C,IAAI;CACJ,8CAA8C;CAC9C,IAAI;CACJ,+CAA+C;CAC/C,IAAI;CACJ,wCAAwC;CACxC,IAAI;CACJ,0DAA0D;CAC1D,IAAI;CACJ,4CAA4C;CAC5C,IAAI;CACJ,mCAAmC;CACnC,EAAE;CACF,+EAA+E"}}]
}